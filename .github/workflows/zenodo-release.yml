name: Publish to Zenodo Sandbox

on:
  release:
    types: [published]

jobs:
  publish-zenodo:
    runs-on: ubuntu-latest
    
    steps:
      # 1. RÃ©cupÃ¨re le code
      - name: Checkout
        uses: actions/checkout@v3
      
      # Cache des packages LaTeX
      - name: Cache LaTeX packages
        uses: actions/cache@v3
        id: cache-latex
        with:
          path: |
            /usr/share/texlive
            /usr/share/texmf
            /var/lib/texmf
          key: latex-${{ runner.os }}-v1
      
      # Installation uniquement si cache miss
      - name: Install LaTeX
        if: steps.cache-latex.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-bibtex-extra \
            latexmk
      
      - name: Compile PDF
        run: |
          cd papers/latex
          make
      
      - name: Verify PDF exists
        run: ls -lh papers/latex/main.pdf
      
      # 4. Upload vers Zenodo Sandbox
      - name: Upload to Zenodo
        uses: rseng/zenodo-release@main
        with:
          token: ${{ secrets.ZENODO_SANDBOX_TOKEN }}
          version: ${{ github.event.release.tag_name }}
          zenodo_json: .zenodo.json
          archive: zenodo-release.zip
          # ðŸ”‘ TON DOI CONCEPT ICI
          doi: ${{ secrets.ZENODO_DOI }}
        env:
          ZENODO_URL: 'https://sandbox.zenodo.org/api'